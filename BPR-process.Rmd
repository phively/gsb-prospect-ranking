---
title: "Booth Prospect Rankings process"
author: "Paul Hively"
date: "September 7, 2016"
output: html_document
---

This document describes the process for creating and updating the Booth Prospect Rankings.

# Setup

This demonstration uses data from the `All Booth Entities Modeling FY17` report, saved in the shared WebI folders `Biodata & Analytics\Engagement`.

The following resources are needed to follow along:

  * Installation of [R 3.2.0](https://cran.r-project.org/) or later
  * Installation of [RStudio](https://www.rstudio.com/products/RStudio/)
  * The files found in my [gsb-prospect-ranking](https://github.com/phively/gsb-prospect-ranking) GitHub repository -- use the [Clone or download](https://github.com/phively/gsb-prospect-ranking/archive/master.zip) link
  * This document, opened in RStudio
  * `ABE Modeling` tab from the `All Booth Entities Modeling FY17` report, saved as a .csv file

### Installing required R packages

My code makes use of several packages:

```{r see.libraries}
scan("LIBRARIES.txt", what="character")
```

This code will install and load them as necessary. First, install `devtools` and my `wranglR` package:

```{r get.wranglR}
# Check to see if devtools is unavailable
if (!("devtools" %in% utils::installed.packages()[, "Package"])) {
  # If unavailable, install it
  install.packages("devtools")
}

# Check to see if wranglR is unavailable
if (!("wranglR" %in% utils::installed.packages()[, "Package"])) {
  # If unavailable, use devtools to install it via GitHub
  devtools::install_github("phively/wranglR")
}
```

Now load wranglR and use it to install or load the other required libraries:

```{r load.libraries, warning=FALSE, message=FALSE}
# Load wranglR
library(wranglR)

# Feed the libraries specified in LIBRARIES.txt into wranglR's Libraries() function
Libraries(scan(file="LIBRARIES.txt", what="character"))
```

### Importing the data

The following code assumes the `ABE Modeling` tab from `All Booth Entities Modeling FY17.csv` is saved in a `data` subfolder. Since the raw data includes fields like `Name` and `ID` we want to manually create factor levels, rather than have R automatically generate them. Also strip leading and trailing spaces.

```{r import.data, warning=FALSE}
# Import the data
full.data <- read.csv("data/ABE Modeling.csv", stringsAsFactors=FALSE, strip.white=TRUE) %>%
  # Drop any null rows
  filter(!is.na(Entity.ID))
# Use dplyr to select only the fields we need
dat <- full.data %>%
  select(Entity.ID, Entity.Record.Status.Desc, Booth.ClassYr.or.RecYr, Booth.Program, Booth.Program.Group, Entity.Degreed.Alum.Undergrad.Ind, Entity.Ever.FacStaff.Ind, Entity.Parent.Ind, Bus.Title.High.Lvl, Employ.Years.At.Current.Company, Pref.Addr.State.Cd, Pref.Addr.Country.Desc, Gift.Capacity.Numerical.Amt..CR., Research.Capacity, Research.Non.Capacity, Booth.Lifetime.Giving, Giving.FYs.of.Giving, Giving.FY.in.Last.5, Giving.Booth.Allocations.Supported, Giving.Booth.Gifts.Count, Giving.Booth.AF.Gifts, Giving.Ever.Pledged.to.Booth, Gift.Donor.Flag..25k, Giving.AF.Scholarship, Giving.Student.Support, Giving.First.Trans.Dt, Giving.First.Trans.Amt, Spouse.Married.UC.Booth, Rel.Known.Tos.Count, Action.Visit.Count..BUS., Action.NonVisit.Count..BUS., Committees..BUS., Committee.in.Last.3.FY, Committee.Reunion.Active, Vol.Acts..BUS., Vol.Acts.Event.Speaker, Events.Vol.Speaker, Vol.Acts.Was.Club.President, Vol.Act.Student.Supporter, Alloc.Stewardee.Student.Support, Student.Acts..BUS., Student.Acts..BUS..Leader, Scholarships.Count, Awards..BUS., Events.Attended..BUS., Events.Attended..BUS..Reunion, Events.Attended..BUS..Student, Events.Attended.in.Last.3.FY..BUS., Nonprofit.Leadership.Flag, Non.UChicago.Notable.Vol.Flag, In.Magazine) %>%
  # Create the response variable
  mutate(Gift.Donor.Flag..25k = ifelse(Gift.Donor.Flag..25k == "Y", 1, 0)) %>%
  # Create factors as needed
  mutate_at(vars(Entity.Record.Status.Desc, Booth.Program, Booth.Program.Group, Entity.Degreed.Alum.Undergrad.Ind, Entity.Ever.FacStaff.Ind, Entity.Parent.Ind, Pref.Addr.State.Cd, Pref.Addr.Country.Desc, Giving.Ever.Pledged.to.Booth, Spouse.Married.UC.Booth, Nonprofit.Leadership.Flag, Non.UChicago.Notable.Vol.Flag, In.Magazine), as.factor) %>%
  # Drop unused factor levels
  droplevels() %>%
  # Convert currency to numeric as needed
  mutate_at(vars(Gift.Capacity.Numerical.Amt..CR., Booth.Lifetime.Giving, Giving.First.Trans.Amt), CurrencyToNumeric) %>%
  # Convert string to date as needed
  mutate(Giving.First.Trans.Dt = ToDate(Giving.First.Trans.Dt, method="mdy"))
```
