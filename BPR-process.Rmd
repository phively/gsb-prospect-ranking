---
title: "Booth Prospect Rankings process"
author: "Paul Hively"
date: "September 7, 2016"
output: html_document
---

This document describes the process for creating and updating the Booth Prospect Rankings.

# Setup

This demonstration uses data from the `All Booth Entities Modeling FY17` report, saved in the shared WebI folders `Biodata & Analytics\Engagement`.

The following resources are needed to follow along:

  * Installation of [R 3.2.0](https://cran.r-project.org/) or later
  * Installation of [RStudio](https://www.rstudio.com/products/RStudio/)
  * The files found in my [gsb-prospect-ranking](https://github.com/phively/gsb-prospect-ranking) GitHub repository -- use the [Clone or download](https://github.com/phively/gsb-prospect-ranking/archive/master.zip) link
  * This document, opened in RStudio
  * `ABE Modeling` tab from the `All Booth Entities Modeling FY17` report, saved as a .csv file

### Installing required R packages

My code makes use of several packages:

```{r see.libraries}
scan("LIBRARIES.txt", what="character")
```

This code will install and load them as necessary. First, install `devtools` and my `wranglR` package:

```{r get.wranglR}
# Check to see if devtools is unavailable
if (!("devtools" %in% utils::installed.packages()[, "Package"])) {
  # If unavailable, install it
  install.packages("devtools")
}

# Check to see if wranglR is unavailable
if (!("wranglR" %in% utils::installed.packages()[, "Package"])) {
  # If unavailable, use devtools to install it via GitHub
  devtools::install_github("phively/wranglR")
}
```

Now load wranglR and use it to install or load the other required libraries:

```{r load.libraries, warning=FALSE, message=FALSE}
# Load wranglR
library(wranglR)

# Feed the libraries specified in LIBRARIES.txt into wranglR's Libraries() function
Libraries(scan(file="LIBRARIES.txt", what="character"))
```

### Preparing the data

The following code assumes the `ABE Modeling` tab from `All Booth Entities Modeling FY17.csv` is saved in a `data` subfolder. Since the raw data includes fields like `Name` and `ID` we want to manually create factor levels, rather than have R automatically generate them. Also strip leading and trailing spaces.

```{r import.data, warning=FALSE}
# Import the data
full.data <- read.csv("data/ABE Modeling.csv", stringsAsFactors=FALSE, strip.white=TRUE) %>%
  # Drop any null rows
  filter(!is.na(Entity.ID))
```

The [following code](https://github.com/phively/gsb-prospect-ranking/blob/master/R/clean.data.R) creates a `dat` data frame from `full.data` -- the `source()` command runs the specified external file as an R script. It creates factors, converts strings to dates and numeric fields, and filters the data to only include non-duplicate alumni records.

```{r clean.data}
source("R/clean.data.R")
```

# Data exploration and variable selection

The cleaned data frame `dat` is substantial:

```{r data.size}
dim(dat)
```

Practically speaking, this is too large to fully explore and experiment with various combinations of variables, transformations, etc. I generally will look at the response variables and a couple key predictors I definitely want to include/exclude (based on domain knowledge) and then use an automatic variable selection routine to reduce the number of predictors.

### Response variable

I had previously decided to treat this as a classification problem. The response variable is `Gift.Donor.Flag..25k`, which is 1 for individuals who have ever made a single $25,000+ gift to Booth and 0 otherwise. Here's the frequency table, as well as a plot of the response against `Booth.ClassYr.or.RecYr`, a proxy for age (which is `NA` for a large proportion of the data).

```{r plot.response}
# Frequency table
table(dat$Gift.Donor.Flag..25k)

# Donor status versus year
dat %>%
  # Set up the axes
  ggplot(aes(x=Booth.ClassYr.or.RecYr)) +
  # Plot the donor and nondonor groups
  geom_density(alpha=.5, aes(color=Gift.Donor.Flag..25k, fill=Gift.Donor.Flag..25k)) +
  # Reference lines for the group means
  geom_vline(xintercept = dat %>% filter(Gift.Donor.Flag..25k=="Nondonor") %>% select(Booth.ClassYr.or.RecYr) %>% unlist() %>% mean(),
             linetype="dashed", color="pink", alpha=.75) +
  geom_vline(xintercept = dat %>% filter(Gift.Donor.Flag..25k=="Donor") %>% select(Booth.ClassYr.or.RecYr) %>% unlist() %>% mean(),
             linetype="dashed", color="turquoise", alpha=.75) +
  # Title and axis labels
  labs(title="Density plot of donor status by record year with group means", x="Year")
```

Only about 1% of the alumni population has given at the $25,000+ level, and the donor group is about 10 years older than the nondonor group.